trigger:
- main

pool:
  name: agentPoolPucMinas
  demands:
    - Agent.Name -equals mac-agent-pucminas-01

variables:
  location: 'brazilsouth'
  resourceGroupName: 'rg-iac-web-iis-brs'
  vmName: 'vm-iac-web-iis'
  vmSkuFallbacks: 'Standard_B1s Standard_B2s Standard_B2ms Standard_DS1_v2'
  indexUrl: 'https://raw.githubusercontent.com/lmlpuc/lmlarm003/refs/heads/main/src/index.html'
  scriptUrl: 'https://raw.githubusercontent.com/lmlpuc/lmlarm003/refs/heads/main/src/scripts/site.ps1'

stages:
- stage: DeployInfra
  displayName: 'Provisionar Infraestrutura'
  jobs:
  - job: Deploy
    displayName: 'Criar RG e recursos ARM'
    steps:
    - task: AzureCLI@2
      displayName: 'Garantir Resource Group'
      inputs:
        azureSubscription: 'ar01com'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e
          if az group show --name "$(resourceGroupName)" >/dev/null 2>&1; then
            rgLoc=$(az group show --name "$(resourceGroupName)" --query location -o tsv)
            echo "RG $(resourceGroupName) já existe em: $rgLoc"
            if [ "$rgLoc" != "$(location)" ]; then
              echo "Erro: RG existe em $rgLoc, mas pipeline está em $(location). Ajuste resourceGroupName ou location."
              exit 1
            fi
          else
            az group create --name "$(resourceGroupName)" --location "$(location)"
          fi

    - task: AzureCLI@2
      displayName: 'Selecionar SKU disponível no brazilsouth'
      inputs:
        azureSubscription: 'ar01com'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e

          echo "Candidatas: $(vmSkuFallbacks)"
          chosen=""

          for sku in $(vmSkuFallbacks); do
            echo "Testando SKU: $sku"

            restrictions=$(az vm list-skus \
              --location "$(location)" \
              --resource-type virtualMachines \
              --query "[?name=='$sku'] | [0].restrictions" -o json)

            # Se restrictions for null ou [], consideramos disponível para a assinatura naquela região
            if [ "$restrictions" = "null" ] || [ "$restrictions" = "[]" ]; then
              chosen="$sku"
              echo "SKU escolhida: $chosen"
              break
            fi
          done

          if [ -z "$chosen" ]; then
            echo "Nenhuma SKU candidata está disponível em $(location)."
            echo "Rode manualmente: az vm list-skus --location $(location) --resource-type virtualMachines -o table"
            exit 1
          fi

          echo "##vso[task.setvariable variable=vmSkuChosen]$chosen"

    - task: AzureResourceManagerTemplateDeployment@3
      displayName: 'Deploy ARM Template'
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: 'ar01com'
        action: 'Create Or Update Resource Group'
        resourceGroupName: '$(resourceGroupName)'
        location: '$(location)'
        templateLocation: 'Linked artifact'
        csmFile: 'arm-templates/vm-iis-template.json'
        csmParametersFile: 'arm-templates/vm-iis-parameters.json'
        overrideParameters: >
          -vmSku "$(vmSkuChosen)"
          -vmName "$(vmName)"
          -location "$(location)"
        deploymentMode: 'Incremental'
        deploymentName: 'vm-iis-deployment'

- stage: ConfigureWebsite
  displayName: 'Publicar site no IIS'
  dependsOn: DeployInfra
  condition: succeeded()
  jobs:
  - job: PublishHTML
    displayName: 'Executar CustomScriptExtension para copiar index.html'
    steps:
    - task: AzureCLI@2
      displayName: 'Executar CustomScriptExtension'
      inputs:
        azureSubscription: 'ar01com'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          cat <<EOF > customScriptSettings.json
          {
            "fileUris": [
              "$(scriptUrl)"
            ],
            "commandToExecute": "powershell -ExecutionPolicy Bypass -File site.ps1"
          }
          EOF

          az vm extension set \
            --resource-group "$(resourceGroupName)" \
            --vm-name "$(vmName)" \
            --name CustomScriptExtension \
            --publisher Microsoft.Compute \
            --settings customScriptSettings.json